<?php
/**
 * @file
 * Code for the Mukurtu Core feature.
 */

include_once('ma_core.features.inc');

/**
 * Implementation of hook_init().
 */
function ma_core_init() {

  // Add the JS for jquery_ui_tooltips. Simply use the class "jquery_ui_tooltip" on any title attribute to use this
  drupal_add_js(drupal_get_path('module', 'ma_core') . '/js/jquery_ui_tooltips.js');
}

/**
 * Implements hook_user_login
 */
function ma_core_user_login(&$edit, $account) {

  //// Redirect user on login

  $current_path = current_path();

  // Do not redirect when user is logged in during profile installation, as more work needs to complete first
  if ($_GET['profile']) {
    return;
  }
  // Do not redirect when not coming from the login page, eg.
  // 1. if path is user/redirect, user is performing a password reset, as we do not want to override the redirect to password change form
  // 2. if this is a Mukurtu Mobile login to the services endpoint (see https://www.drupal.org/node/2394235)
  elseif ($current_path <> 'user' AND $current_path <> 'user/login') {
    return;
  }

  global $user;
  if (array_intersect(array('administrator', 'Mukurtu Administrator'), $user->roles)) {
    drupal_goto('dashboard');
  }
  else {
    drupal_goto(); // Non-admin users go to front page
  }
}

/**
 * Get NIDs from an array of nodes
 */
function ma_core_get_nids_from_array_of_nodes ($nodes = NULL) {
  $nids = array();
  if ($nodes) {
    foreach ($nodes as $node) {
      $nids[] = $node->nid;
    }
  }
  return $nids;
}

/**
 * Implements hook_views_pre_view().
 */
function ma_core_views_pre_view(&$view, &$display_id, &$args) {
  if ($view->name == 'group_members') {

    // Hide the manage/add members links in footer unless user can admin this group.
    if (is_numeric(arg(1))) {
      $gid = arg(1);
      if (!og_user_access('node', $gid, 'manage members')) {
        $view->set_item_option('block_1', 'footer', 'area', 'content', NULL);
      }
    }
  }
}

/**
 * Implements hook_views_pre_render().
 */
function ma_core_views_pre_render(&$view) {
  if ($view->name == 'group_members') {
    if (is_numeric(arg(1))) {
      $gid = arg(1);

      // Add the user role(s) after the user names. This can't quite be done in view config alone.
      $results = &$view->result;
      $roles_order = [
        'Community Manager',
        'Protocol Steward',
        'Contributor'
      ];
      foreach ($results as &$result) {
        $roles = og_get_user_roles('node', $gid, $result->uid);
        $formatted_roles = [];
        foreach ($roles as $role) {
          if ($role <> 'member') {
            $formatted_roles[] = ucwords ($role);
          }
        }
        if (count($formatted_roles)) {
          usort ($formatted_roles, "ma_core_sort_og_roles");
          $result->users_name = $result->users_name . ' (' . implode(', ', $formatted_roles) . ')';
        }
      }

    }
  }
}

/**
 * Helper function to sort the OG roles so that Protocol Steward is listed ahead of Contributor.
 */
function ma_core_sort_og_roles($leftItem, $rightItem){
  $order =  $roles_order = [
    'Community Manager',
    'Protocol Steward',
    'Contributor'
  ];

  $flipped = array_flip($order);

  $leftPos = $flipped[$leftItem];
  $rightPos = $flipped[$rightItem];
  return $leftPos >= $rightPos;
}

/**
 * Helper function based on og_extras_get_users_by_roles,
 * but takes role name instead of ID (thus also requiring group bundle param),
 * and returns user objects instead of raw query results.
 */
function ma_core_og_get_users_per_role_and_group ($role_name, $group_bundle, $gid) {
  if ($rid = array_search ($role_name, og_roles('node', $group_bundle, $gid))) {
    $query = db_select('og_users_roles', 'og_users_roles');
    $query->fields('og_users_roles', array('uid'))
      ->condition('gid', $gid)
      ->condition('rid', array ($rid), 'IN')
    ;
    if ($results = $query->execute()
      ->fetchAll()) {
      $uids = array();
      foreach ($results as $result) {
        $uids[] = $result->uid;
      }
      return user_load_multiple ($uids);
    }
  }
}

/**
 * Get all users of a group
 */
function ma_core_og_get_users_in_group($gid) {
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'user')
    ->fieldCondition('og_user_node', 'target_id', $gid);

  if ($results = $query->execute()) {
    $uids = array_keys($results['user']);
    return user_load_multiple($uids);
  }
}

/**
 * Helper function to load users by core role.
 */
function ma_core_get_users_per_role ($role_name) {
  if ($role = user_role_load_by_name($role_name)) {
    $query = 'SELECT DISTINCT(ur.uid)  FROM {users_roles} AS ur WHERE ur.rid = (:rid)';
    $result = db_query($query, [':rid' => $role->rid]);
    $uids = $result->fetchCol();
    return user_load_multiple($uids);
  }
}

/**
 * Implements hook_menu().
 */
function ma_core_menu() {

  $items = array();
  // Empty home (front) page, added onto via context
  $items['home'] = array(
    'page callback' => 'ma_core_blank_page_callback',
    'access callback' => TRUE,
    'type' => MENU_SUGGESTED_ITEM,
  );

  // Release Notes page
  $version = ma_core_get_version();
  $items['release-notes'] = array(
    'title' => t($version . ' Release Notes'),
    'description' => 'Mukurtu Release Notes',
    'page callback' => 'ma_core_release_notes',
    'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM,
    'weight' => 20,
  );
  return $items;
}

/**
 * Display the content for your blank page.
 */
function ma_core_blank_page_callback() {
  return ' ';
}

/**
 * Menu callback; Mukurtu Release Notes
 */
function ma_core_release_notes () {

  $file = nl2br(file_get_contents('VERSION.md'));
  return check_markup($file, 'markdown');
}


/**
 * Explodes a string of tags into an array.
 * Tweaked drupal_explode_tags that a) uses semicolon instead of comma as delimter, and b) no special handling (ie. not an escape) for quotes
 **/
function ma_core_taxonomy_explode_tags($tags) {
  $regexp = '%(?:^|;\ *)("(?>[^"]*)(?>""[^"]* )*"|(?: [^;]*))%x';
  preg_match_all($regexp, $tags, $matches);
  $typed_tags = array_unique($matches[1]);

  $tags = array();
  foreach ($typed_tags as $tag) {
    $tag = trim($tag);
    if ($tag != "") {
      $tags[] = $tag;
    }
  }

  return $tags;
}

/**
 * Get the version from first line of version.md
 */
function ma_core_get_version() {

  $version_path = DRUPAL_ROOT . '/VERSION.md';
  if (file_exists($version_path)) {
    if ($version_file = fopen($version_path, 'r')) {
      $version = trim(fgets($version_file));
      if ($version = strstr ($version, 'Mukurtu ')) {
        return $version;
      }
    }
  }
}


/**
 * Get a taxonomy term object from a term name in a vocab. Create one if the term doesn't yet exist.
 */
function ma_core_get_create_tax_term ($term_name, $vocab_name) {
  if ($term = taxonomy_get_term_by_name($term_name, $vocab_name)) {
    return current($term);
  }
  else {
    $term = new StdClass();
    $vocab = taxonomy_vocabulary_machine_name_load($vocab_name);
    $term->vid = $vocab->vid;
    $term->name = $term_name;
    taxonomy_term_save($term);
    return $term;
  }
}

/**
 * Implementation of HOOK_form_alter()
 */
function ma_core_form_alter(&$form, $form_state, $form_id) {

  // Duplicate a the node form action buttons at the top of the form.
  // Normally we could just duplicate the field here and set its weight,
  // but because our forms are managed in DS, the field needs to be created there
  // first, or else we can't move the field high enough on the form. So we create
  // a dummy Pre-Actions field (a boolean) in Manage Fields, and then rewrite it here,
  // simply duplicating the contents of form actions as they appear at bottom.
  if (isset($form['#node_edit_form']) AND $form['#node_edit_form']) {
    $form['field_pre_actions'] = $form['actions'];
    $form['field_pre_actions']['#weight'] = -5; // for those content types where the field layout is not in DS.
  }

}

/**
 * Implementation of hook_block_info().
 */
function ma_core_block_info() {
  $blocks['create_content'] = array(
    'info' => t('Create Content'),
  );
  return $blocks;
}

/**
 * Implementation of hook_block_view().
 */
function ma_core_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'create_content':
      $block['subject'] = t('Create Content');
      $block['content'] = ma_core_create_content_block();
      break;
  }
  return $block;
}

/**
 * The Create Content block which appears on the Community, CP, Calendar Section, Discussion Section, and Document Section node views.
 */
function ma_core_create_content_block() {

  $nid = arg(1);
  if (is_numeric($nid)) {
    $node = node_load($nid);

    switch ($node->type) {
      case 'community':
        $link_sources = [
          'cultural_protocol_group' => '?og_group_ref=' . $nid,
          'digital_heritage' => '/' . $nid,
        ];
        break;
      case 'cultural_protocol_group':
        $link_sources = [
          'digital_heritage' => '/' . $node->og_group_ref[LANGUAGE_NONE][0]['target_id']. '/' . $nid,
        ];
        if (module_exists('ma_collaboration_tools')) {
          foreach (ma_collaboration_tools_parent_node_types() as $parent_type) {
            $link_sources[$parent_type] = '/' . $node->og_group_ref[LANGUAGE_NONE][0]['target_id'] . '/' . $nid;
          }
        }
        break;
      default:
        return; // Safeguard. This should never happen.
    }

    // Output the links
    $links = "";
    foreach ($link_sources as $target_type => $link_query) {
      $target_type_link = str_replace('_', '-', $target_type);
      if (og_user_access('node', $nid, 'create ' . $target_type . ' content')) {
        $links .= '<div class="view-content"><a href="' . '/node/add/' . $target_type_link . $link_query . '">Create ' . node_type_get_names()[$target_type] . '</a></div>';
      }
    }

    return $links;
  }
}
