<?php
/**
 * @file
 * Code for the Mukurtu File Fixity feature.
 */

include_once 'ma_file_fixity.features.inc';

/**
 * Bulk generate the file hashes for all existing files. Called once by an ma_core update hook
 */
function ma_file_fixity_bulk_generate_file_hashes() {
     $query = new EntityFieldQuery();
    $files = $query->entityCondition('entity_type', 'file')
      ->addMetaData('account', user_load(1))
      ->execute();
    foreach ($files['file'] as $file) {
      file_load($file->fid); // The hashes are generated on file load if they do yet not exist for the file.
    }
    drupal_set_message($message = t('Added file hashes for ' . count($files['file']) . ' files.'), $type = 'status');
}


/**
 * Implements hook_form_FORM_ID_alter().
 */
function ma_file_fixity_form_fixity_check_node_form_alter(&$form, &$form_state) {

  // The Fixity Check node title gets set automatically.
  $form['title']['#access'] = FALSE;
  $form['title']['#required'] = FALSE;

}

/**
 * Implements hook_entity_presave().
 */
function ma_file_fixity_entity_presave($entity, $type) {
  if ($entity->type == 'fixity_check') {

    // Set the Fixity Check node title
    $schedule = ucfirst($entity->field_fixity_schedule['und'][0]['value']);
    if (empty($schedule)) {
      $schedule = 'Unscheduled';
    }
    $schedule = str_replace('x', $entity->field_fixity_days_frequency['und'][0]['value'], $schedule);
    $cps = $entity->field_fixity_cps['und'];
    if (count($cps)) {
      $cp_names = [];
      foreach ($cps as $cp) {
        $cp_node = node_load ($cp['target_id']);
        $cp_names[] = $cp_node->title;
      }
      $cps_title = implode(', ', $cp_names);
    }
    else {
      $cps_title = 'all media assets';
    }
    $entity->title = $schedule . ' - ' . $cps_title;

  }
}

